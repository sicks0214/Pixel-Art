# ✅ VPS部署前检查清单 - pixelartland.cc

## 📋 本地准备（部署前）

### 代码检查
- [x] **默认语言已设置为英语**
  - `frontend/src/i18n/core/I18nManager.ts` → `defaultLocale: 'en'` ✅
  
- [x] **SEO描述已优化**
  - `frontend/index.html` → Meta description: 142字符 ✅
  - `frontend/src/components/SEO.tsx` → 描述已更新 ✅

- [x] **CORS支持多域名**
  - `backend/src/index.ts` → `ALLOWED_ORIGINS` 环境变量支持 ✅

- [x] **Dockerfile符合指南**
  - `backend/Dockerfile.simple` → 单阶段构建 ✅
  - 时区: `TZ=America/New_York` ✅
  - 健康检查: 已配置 ✅

- [x] **构建脚本就绪**
  - `build-frontend.sh` → 分离式构建 ✅
  - `deploy.sh` → 容器名改为site2 ✅

### Git准备
- [ ] **提交所有修改**
  ```bash
  git status
  git add .
  git commit -m "feat: 准备VPS部署到pixelartland.cc"
  git push origin main
  ```

---

## 🖥️ VPS环境检查

### 基础环境
- [ ] **VPS已安装Docker**
  ```bash
  docker --version
  # 需要: Docker 20.10+
  ```

- [ ] **VPS已安装Docker Compose**
  ```bash
  docker compose version
  # 需要: v2.0+
  ```

- [ ] **Nginx Proxy Manager已运行**
  ```bash
  docker ps | grep nginx-proxy-manager
  ```

### 网络配置
- [ ] **webproxy网络已创建**
  ```bash
  docker network ls | grep webproxy
  # 如果没有，执行: docker network create webproxy
  ```

- [ ] **shared_net网络已创建**
  ```bash
  docker network ls | grep shared_net
  # 如果没有，执行: docker network create shared_net
  ```

### 目录准备
- [ ] **/docker目录已创建**
  ```bash
  mkdir -p /docker/site2
  cd /docker/site2
  ```

---

## 🌐 域名配置检查

### Cloudflare设置
- [ ] **域名已添加到Cloudflare**
  - pixelartland.cc ✅
  - www.pixelartland.cc ✅

- [ ] **DNS记录已配置**
  - A记录: pixelartland.cc → VPS_IP ✅
  - CNAME记录: www.pixelartland.cc → pixelartland.cc ✅

- [ ] **初始设置为灰云☁️**
  - ⚠️ 申请SSL证书前必须是灰云状态
  - 证书申请成功后再切换为橙云🟠

---

## 📝 环境变量配置

### 必需的环境变量
- [ ] **创建backend/.env文件**
  ```bash
  cp env.vps.example backend/.env
  nano backend/.env
  ```

- [ ] **配置ALLOWED_ORIGINS**
  ```bash
  ALLOWED_ORIGINS=https://pixelartland.cc,https://www.pixelartland.cc
  ```

- [ ] **配置基础变量**
  ```bash
  NODE_ENV=production
  PORT=3001
  TZ=America/New_York
  ENABLE_DATABASE=false
  ENABLE_REDIS_CACHE=false
  ```

### 验证配置
- [ ] **检查环境变量格式**
  ```bash
  cat backend/.env | grep ALLOWED_ORIGINS
  # 格式：英文逗号，无空格，https://
  ```

---

## 🚀 部署执行

### 上传代码
- [ ] **方式A: Git克隆**
  ```bash
  cd /docker
  git clone YOUR_REPO_URL temp
  mv temp/site2/* ./site2/
  rm -rf temp
  ```

- [ ] **方式B: rsync推送**
  ```bash
  # 本地执行
  rsync -avz --exclude 'node_modules' \
    ~/Documents/GitHub/Pixel-Art/site2/ \
    root@VPS_IP:/docker/site2/
  ```

### 执行部署
- [ ] **运行部署脚本**
  ```bash
  cd /docker/site2
  chmod +x build-frontend.sh deploy.sh
  ./deploy.sh
  ```

- [ ] **等待部署完成**
  - 预计时间: 10-15分钟（首次部署）
  - 看到"部署成功"提示

---

## 🔧 Nginx Proxy Manager配置

### 主域名配置
- [ ] **添加代理主机 - pixelartland.cc**
  - Domain Names: `pixelartland.cc`
  - Scheme: `http`
  - Forward Hostname/IP: `site2` 或容器IP
  - Forward Port: `3001`
  - Block Common Exploits: ✅
  - Websockets Support: ✅

- [ ] **申请SSL证书**
  1. 确认Cloudflare是灰云☁️
  2. 在SSL标签申请Let's Encrypt证书
  3. Force SSL: ✅
  4. 等待证书申请成功

### www子域名配置
- [ ] **添加代理主机 - www.pixelartland.cc**
  - Domain Names: `www.pixelartland.cc`
  - 其他配置同主域名
  - SSL证书也需要单独申请

### Cloudflare切换
- [ ] **切换为橙云🟠**
  - 证书申请成功后
  - 两个域名都切换为橙云

---

## ✅ 验证测试

### 容器状态
- [ ] **容器正常运行**
  ```bash
  docker ps | grep site2
  # 状态应该是 Up X minutes (healthy)
  ```

- [ ] **健康检查通过**
  ```bash
  docker exec site2 curl -s http://localhost:3001/api/health
  # 返回: {"status":"ok",...}
  ```

- [ ] **查看日志无错误**
  ```bash
  docker logs site2 --tail 50
  # 没有ERROR或WARN级别错误
  ```

### CORS配置
- [ ] **CORS日志正确**
  ```bash
  docker logs site2 | grep "允许的CORS源"
  # 应该看到两个域名
  ```

### 网络连接
- [ ] **webproxy网络已连接**
  ```bash
  docker network inspect webproxy | grep site2
  ```

- [ ] **shared_net网络已连接**
  ```bash
  docker network inspect shared_net | grep site2
  ```

### 域名访问
- [ ] **主域名HTTP访问正常**
  ```bash
  curl -I http://pixelartland.cc
  # 应该返回 301 Redirect to HTTPS
  ```

- [ ] **主域名HTTPS访问正常**
  ```bash
  curl -I https://pixelartland.cc
  # 应该返回 200 OK
  ```

- [ ] **www域名HTTPS访问正常**
  ```bash
  curl -I https://www.pixelartland.cc
  # 应该返回 200 OK
  ```

### 浏览器测试
- [ ] **打开主域名**
  - 访问: https://pixelartland.cc
  - 加载正常，无报错
  - 界面默认英语
  - SSL证书有效🔒

- [ ] **打开www域名**
  - 访问: https://www.pixelartland.cc
  - 加载正常，无CORS错误
  - 功能正常

### 功能测试
- [ ] **上传图片测试**
  - 选择图片文件
  - 上传成功
  - 无网络错误

- [ ] **像素化转换测试**
  - 调整参数
  - 实时预览正常
  - 转换成功

- [ ] **下载图片测试**
  - 点击下载按钮
  - 文件下载成功
  - 格式正确（PNG/JPG）

- [ ] **语言切换测试**
  - 切换到中文
  - 切换到日语
  - 界面翻译正常

---

## 📊 部署结果记录

### 部署信息
```
部署日期: ___________
VPS IP: ___________
容器名称: site2
容器IP: ___________
```

### 域名配置
```
主域名: https://pixelartland.cc
www域名: https://www.pixelartland.cc
SSL证书: Let's Encrypt
CDN: Cloudflare (橙云🟠)
```

### 性能指标
```
容器启动时间: ______秒
健康检查响应: ______ms
首屏加载时间: ______秒
图像处理时间: ______秒
```

---

## 🐛 常见问题快速修复

### 问题1: www域名500错误
```bash
# 检查CORS配置
docker logs site2 | grep "CORS阻止"
# 修改.env添加www域名后重启
docker restart site2
```

### 问题2: SSL证书申请失败
```bash
# 确认Cloudflare是灰云
# 等待5分钟后重试
# 检查80端口是否开放
```

### 问题3: 容器无法启动
```bash
# 查看详细日志
docker logs site2 --tail 100
# 检查.env文件是否存在
ls -la backend/.env
```

---

## 📞 支持资源

- **完整部署指南**: `VPS部署指南_pixelartland.cc.md`
- **问题处理指南**: `docs/VPS部署问题处理指南 1001.md`
- **架构设计规范**: `docs/从零指导程序开发建设 1001.md`

---

**检查人**: ___________  
**检查日期**: ___________  
**部署状态**: ⬜ 未开始 / ⬜ 进行中 / ⬜ 已完成  
**备注**: ___________________________________________

